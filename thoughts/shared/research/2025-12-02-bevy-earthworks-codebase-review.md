---
date: 2025-12-02T06:48:17+00:00
researcher: reuben
git_commit: 7a15a9dcfecf7e4b0745182e4b165b90875388ab
branch: main
repository: bevy (fork)
topic: "bevy_earthworks PRD and Tasks Review"
tags: [research, codebase, bevy_earthworks, voxel-terrain, plugin-architecture]
status: complete
last_updated: 2025-12-02
last_updated_by: reuben
---

# Research: bevy_earthworks PRD and Tasks Review

**Date**: 2025-12-02T06:48:17+00:00
**Researcher**: reuben
**Git Commit**: 7a15a9dcfecf7e4b0745182e4b165b90875388ab
**Branch**: main
**Repository**: bevy (fork)

## Research Question

Review the codebase, PRD, and tasks for the bevy_earthworks project to understand the current state and planned implementation.

## Summary

**bevy_earthworks does not exist yet** - the crate needs to be created from scratch. The project is currently in the **ideation phase** with a complete PRD and task breakdown, but no implementation has begun. The repository is a fork of Bevy v0.18.0-dev with 55+ existing crates that provide the foundation for the planned plugin.

### Project Status
- **Workflow State**: `ideation` phase (not yet implementation)
- **PRD**: Complete, 2799 lines of detailed specification
- **Tasks**: 11 parent tasks with 47 subtasks, all pending
- **Code**: Zero lines written for bevy_earthworks

## Detailed Findings

### 1. Project Overview

**bevy_earthworks** is a planned Bevy plugin providing:
- Volumetric voxel terrain with efficient modification and rendering
- Construction machine simulation with work envelope constraints
- Plan execution and playback system for pre-computed operations
- Timeline UI for interactive visualization

**Primary Purpose**: Serve as the visualization layer for TerraFirma, rendering optimized earthworks plans generated by Julia.

**Brownfield Challenge**: This satisfies the requirement to fork a substantial open-source repo (Bevy: 37k+ stars) and build a non-trivial extension.

### 2. Planned Crate Structure

From PRD (`.scud/docs/prd_init.md:144-203`):

```
bevy/crates/bevy_earthworks/
├── Cargo.toml
├── src/
│   ├── lib.rs             # Plugin entry, prelude
│   ├── terrain/
│   │   ├── mod.rs
│   │   ├── voxel.rs       # Voxel data structures
│   │   ├── chunk.rs       # Chunk management
│   │   ├── operations.rs  # Excavate, fill, query
│   │   ├── meshing.rs     # Greedy mesh algorithm
│   │   └── materials.rs   # Material definitions
│   ├── machines/
│   │   ├── mod.rs
│   │   ├── components.rs  # Machine, Envelope, Mobility
│   │   ├── catalog.rs     # Preset definitions
│   │   ├── animation.rs   # State machine, interpolation
│   │   └── gizmos.rs      # Debug visualization
│   ├── plan/
│   │   ├── mod.rs
│   │   ├── schema.rs      # Plan, Step, Action types
│   │   ├── loader.rs      # JSON asset loader
│   │   ├── executor.rs    # Playback system
│   │   └── timeline.rs    # Keyframe interpolation
│   ├── scoring/
│   ├── ui/
│   ├── camera/
│   ├── effects/
│   └── export/
├── examples/
└── tests/
```

### 3. Task Breakdown

From `.scud/tasks/tasks.scg`:

| ID | Task | Complexity | Status |
|----|------|------------|--------|
| 1 | Set up project structure and EarthworksPlugin | 3 | Pending |
| 2 | Implement voxel, chunk, and VoxelTerrain data structures | 5 | Pending |
| 3 | Add terrain operations (excavate, fill) and dirty tracking | 5 | Pending |
| 4 | Implement simple cube meshing and chunk rendering | 8 | Pending |
| 5 | Define plan schema and ExecutionPlan asset loader | 3 | Pending |
| 6 | Initialize terrain and spawn machines from loaded plan | 8 | Pending |
| 7 | Implement PlanPlayback and basic plan executor | 8 | Pending |
| 8 | Add machine components, activities, and animation system | 8 | Pending |
| 9 | Upgrade to greedy meshing algorithm | 13 | Pending |
| 10 | Implement UI timeline, overlay, and controls | 5 | Pending |
| 11 | Add scoring tracker, gizmos, and basic camera | 5 | Pending |

**Total Complexity**: 71 points across 47 subtasks

### 4. Bevy Integration Points

Based on analysis of existing Bevy crates:

#### Plugin System (`crates/bevy_app`)
- `Plugin` trait at `plugin.rs:57-92` - build(), ready(), finish(), cleanup() lifecycle
- `App::add_plugins()` at `app.rs:626` for plugin registration
- `App::add_systems()` at `app.rs:322-329` for system registration
- `App::add_message()` at `app.rs:411-414` for event/message registration
- Resources via `App::insert_resource()` and `App::init_resource()`

#### Asset Loading (`crates/bevy_asset`)
- `AssetLoader` trait at `loader.rs:31-51` for custom asset types
- Async `load()` method receives `Reader`, settings, and `LoadContext`
- `extensions()` returns supported file extensions (e.g., `["plan.json"]`)
- `App::init_asset::<T>()` and `App::init_asset_loader::<L>()` for registration

#### Mesh System (`crates/bevy_mesh`, `crates/bevy_pbr`)
- `Mesh` struct at `mesh.rs:121-153` stores vertex data and indices
- Built-in attributes: POSITION, NORMAL, UV_0, UV_1, TANGENT, COLOR
- `Mesh3d` component at `components.rs:95-98` references mesh handle
- `MeshMaterial3d<M>` at `mesh_material.rs:39-41` applies materials
- `StandardMaterial` at `pbr_material.rs:30-35` for PBR rendering

#### Gizmos System (`crates/bevy_gizmos`)
- `Gizmos` system parameter at `gizmos.rs:143-153` for immediate mode drawing
- Primitives: `line()`, `circle()`, `arc_3d()`, `rect()`, `cube()`, `sphere()`
- Colors via `impl Into<Color>` converted to `LinearRgba`
- Builder pattern for complex shapes (circles, arcs, grids, rounded boxes)

#### UI System
- **Note**: `bevy_egui` is NOT included in Bevy core
- Bevy uses native `bevy_ui` with flexbox-based layout
- For egui integration, external `bevy_egui` crate required as dependency
- PRD specifies egui for timeline/overlay UI - this will be an external dependency

### 5. Key Technical Specifications

#### Voxel System
- **Voxel size**: 0.3048m (1 foot)
- **Chunk size**: 16x16x16 voxels
- **Materials**: Dirt, Clay, Rock, Topsoil, Gravel
- **States**: Empty, Solid, Disturbed

#### Machine Types
- **Excavator**: Toroidal work envelope (donut-shaped reach)
- **Dozer**: Blade envelope (rectangular push zone)
- **Loader**: Bucket envelope (frontal scoop area)

#### Plan Format
- JSON with version, metadata, site definition, machines, steps, results
- Base64 RLE-encoded terrain data
- Steps with timestamp, machine ID, and action (MoveTo, Excavate, Dump, etc.)

#### Performance Targets
- Terrain init (80x80x8): < 100ms
- Mesh generation per chunk: < 5ms
- Frame time: < 16.6ms (60 FPS)
- Memory (terrain): < 100MB
- Plan load: < 50ms

### 6. Dependencies Required

From PRD dependency graph (`.scud/docs/prd_init.md:206-219`):

```toml
[dependencies]
bevy_app = { path = "../bevy_app" }
bevy_ecs = { path = "../bevy_ecs" }
bevy_asset = { path = "../bevy_asset" }
bevy_render = { path = "../bevy_render" }
bevy_pbr = { path = "../bevy_pbr" }
bevy_gizmos = { path = "../bevy_gizmos" }
serde = { version = "1", features = ["derive"] }
serde_json = "1"
base64 = "0.21"
parking_lot = "0.12"

[dependencies.bevy_egui]
# External crate - not in Bevy core
version = "0.x"  # Check latest compatible version
optional = true
```

## Code References

### Existing Bevy Files (for reference patterns)
- `crates/bevy_app/src/plugin.rs:57` - Plugin trait definition
- `crates/bevy_app/src/app.rs:322` - System registration
- `crates/bevy_asset/src/loader.rs:31` - AssetLoader trait
- `crates/bevy_mesh/src/mesh.rs:121` - Mesh struct
- `crates/bevy_gizmos/src/gizmos.rs:143` - Gizmos system param

### Project Files
- `.scud/docs/prd_init.md` - Complete PRD (2799 lines)
- `.scud/tasks/tasks.scg` - Task graph (263 lines)
- `.scud/workflow-state.json` - Current phase: ideation

## Architecture Documentation

### Planned System Execution Order (from PRD)

```
UPDATE SCHEDULE:
1. Input Systems (Bevy built-in)
2. Camera Control (orbit_camera_system, follow_camera_system)
3. Plan Execution (plan_loader_system, plan_executor_system)
4. Terrain Ops (apply_operations, chunk_dirty_system)
5. Machine Update (animation_system, state_machine)
6. Scoring (score_tracker_system)
7. Effects (particle_system)
8. Mesh Generation (mesh_generation_system - async, chunked)
9. UI (timeline_system, overlay_system)
10. Debug Gizmos (draw_work_envelopes, draw_chunk_bounds)
```

### Event Types (planned)
- `TerrainModifiedEvent` - chunk_pos, operation, volume_changed
- `PlanStepEvent` - step_index, step, result
- `MachineEvent` - machine entity, event_type (StartedMoving, ReachedDestination, etc.)

## Open Questions

1. **bevy_egui version**: Which version is compatible with Bevy 0.18.0-dev?
2. **Workspace integration**: How to add new crate to Bevy workspace Cargo.toml?
3. **Feature flags**: Should egui UI be optional feature?
4. **Test fixtures**: Where should sample plan JSON files live?
5. **CI integration**: How to add tests to Bevy's CI pipeline?

## Next Steps

1. **Task 1.1**: Fork repo setup, create `crates/bevy_earthworks/` directory
2. **Task 1.2**: Create `Cargo.toml` with dependencies
3. **Task 1.3**: Implement basic `EarthworksPlugin` with empty systems
4. **Task 2.1**: Define `VoxelState`, `MaterialId`, `Voxel` types

---

*Research completed for bevy_earthworks project planning and codebase understanding.*
