name: Pull Request Labeler
on:
  pull_request:
    types: [opened, ready_for_review, labeled]
jobs:
  add_label:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - run: |
          if [ $ACTION == "labeled" ]; then
            # A new label was added
            if [ $(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/$REPO/pulls/$NUMBER/ | \
            jq 'def find(s): . as $x | s | map(. as $l | $x | bsearch($l) >= 0) | any; .labels| map(.name) | sort | find(["S-Ready-For-Final-Review", "S-Needs-RFC", "S-Blocked", "S-Adopt-Me"])' ) == 'true' ]
            then
              gh issue edit $NUMBER --remove-label 'S-Needs-Review'
            fi
          else
            # A new PR was submitted (or a draft was marked as ready)
            gh issue edit $NUMBER --add-label 'S-Needs-Review'
          fi
        env:
          NUMBER: ${{ github.event.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTION: ${{ github.event.action }}
          REPO: ${{ github.event.repository.full_name }}
